/**\n * 多通道管理API端点\n */\n\nimport { Router, Request, Response } from 'express';\nimport { allocationEngine, AllocationRequest } from '../services/allocation-engine';\nimport { channelManager } from '../config';\n\nconst router = Router();\n\n/**\n * POST /api/v1/channels/add\n * 添加新通道\n */\nrouter.post('/channels/add', async (req: Request, res: Response) => {\n  try {\n    const { userId, channelType, credentials, metadata } = req.body;\n\n    // 验证必填字段\n    if (!userId || !channelType || !credentials) {\n      return res.status(400).json({\n        success: false,\n        message: 'Missing required fields: userId, channelType, credentials'\n      });\n    }\n\n    // 创建分配请求\n    const request: AllocationRequest = {\n      userId,\n      channelType: channelType.toUpperCase(),\n      credentials,\n      metadata\n    };\n\n    // 执行分配\n    const result = await allocationEngine.allocateChannel(request);\n\n    if (result.success) {\n      return res.status(201).json({\n        success: true,\n        data: {\n          channelId: result.channelId,\n          serviceId: result.serviceId,\n          instanceNumber: result.instanceNumber,\n          allocatedService: result.allocatedService\n        },\n        message: result.message\n      });\n    } else {\n      return res.status(400).json({\n        success: false,\n        message: result.message\n      });\n    }\n  } catch (error) {\n    const errorMsg = error instanceof Error ? error.message : String(error);\n    console.error(`Channel add error: ${errorMsg}`);\n    return res.status(500).json({\n      success: false,\n      message: `Internal server error: ${errorMsg}`\n    });\n  }\n});\n\n/**\n * GET /api/v1/services/capacity\n * 获取系统容量信息\n */\nrouter.get('/services/capacity', async (req: Request, res: Response) => {\n  try {\n    const summary = await allocationEngine.getSystemCapacitySummary();\n\n    return res.json({\n      success: true,\n      data: {\n        services: summary.services.map((s) => ({\n          instanceName: s.instanceName,\n          channels: s.totalChannels,\n          availableSlots: s.availableSlots,\n          isFull: s.isFull,\n          utilization: `${Math.round((s.totalChannels / 8) * 100)}%`\n        })),\n        summary: {\n          totalCapacity: summary.totalSystemCapacity,\n          totalUsed: summary.totalUsed,\n          totalAvailable: summary.totalAvailable,\n          systemUtilization: `${Math.round((summary.totalUsed / summary.totalSystemCapacity) * 100)}%`\n        }\n      },\n      message: 'System capacity retrieved successfully'\n    });\n  } catch (error) {\n    const errorMsg = error instanceof Error ? error.message : String(error);\n    console.error(`Capacity query error: ${errorMsg}`);\n    return res.status(500).json({\n      success: false,\n      message: `Internal server error: ${errorMsg}`\n    });\n  }\n});\n\n/**\n * GET /api/v1/channels/list\n * 列出所有通道\n */\nrouter.get('/channels/list', async (req: Request, res: Response) => {\n  try {\n    const allChannels = channelManager.getAllChannels();\n\n    const channelsList = Array.from(allChannels.values()).map((ch) => ({\n      type: ch.type,\n      instanceNumber: ch.instanceNumber,\n      enabled: ch.enabled,\n      initialized: ch.initialized,\n      error: ch.lastError || null\n    }));\n\n    const summary = {\n      total: channelsList.length,\n      byType: {} as { [key: string]: number },\n      failedCount: channelsList.filter((ch) => !ch.initialized).length\n    };\n\n    // 按类型统计\n    for (const ch of channelsList) {\n      if (!summary.byType[ch.type]) {\n        summary.byType[ch.type] = 0;\n      }\n      summary.byType[ch.type]++;\n    }\n\n    return res.json({\n      success: true,\n      data: {\n        channels: channelsList,\n        summary\n      },\n      message: 'Channels retrieved successfully'\n    });\n  } catch (error) {\n    const errorMsg = error instanceof Error ? error.message : String(error);\n    console.error(`Channel list error: ${errorMsg}`);\n    return res.status(500).json({\n      success: false,\n      message: `Internal server error: ${errorMsg}`\n    });\n  }\n});\n\n/**\n * GET /api/v1/channels/health\n * 获取通道健康状态\n */\nrouter.get('/channels/health', (req: Request, res: Response) => {\n  try {\n    const capacityInfo = channelManager.getCapacityInfo();\n    const allChannels = channelManager.getAllChannels();\n    const failedChannels = channelManager.getFailedChannels();\n\n    const health = {\n      status: failedChannels.length === 0 ? 'healthy' : 'degraded',\n      capacity: {\n        total: capacityInfo?.total || 0,\n        available: capacityInfo?.available || 8,\n        isFull: capacityInfo?.isFull || false\n      },\n      channels: {\n        total: allChannels.size,\n        initialized: channelManager.getInitializedChannelCount(),\n        failed: failedChannels.length\n      }\n    };\n\n    return res.json({\n      success: true,\n      data: health,\n      message: 'Health check completed'\n    });\n  } catch (error) {\n    const errorMsg = error instanceof Error ? error.message : String(error);\n    console.error(`Health check error: ${errorMsg}`);\n    return res.status(500).json({\n      success: false,\n      message: `Internal server error: ${errorMsg}`\n    });\n  }\n});\n\n/**\n * GET /api/v1/channels/:channelType\n * 获取特定类型的所有通道\n */\nrouter.get('/channels/:channelType', (req: Request, res: Response) => {\n  try {\n    const { channelType } = req.params;\n    const channels = channelManager.getChannelsByType(channelType);\n\n    const details = channels.map((ch) => ({\n      instanceNumber: ch.instanceNumber,\n      enabled: ch.enabled,\n      initialized: ch.initialized,\n      error: ch.lastError || null,\n      credentials: Object.keys(ch.credentials)\n    }));\n\n    return res.json({\n      success: true,\n      data: {\n        channelType,\n        count: channels.length,\n        channels: details\n      },\n      message: `${channelType} channels retrieved successfully`\n    });\n  } catch (error) {\n    const errorMsg = error instanceof Error ? error.message : String(error);\n    console.error(`Channel type query error: ${errorMsg}`);\n    return res.status(500).json({\n      success: false,\n      message: `Internal server error: ${errorMsg}`\n    });\n  }\n});\n\nexport default router;\n"