/**\n * 数据库迁移：添加多通道支持\n * 时间戳: 2025-01-15_001_add_multi_channel_support\n */\n\nimport { Pool } from 'pg';\n\nconst pool = new Pool();\n\n/**\n * 迁移up：创建多通道相关表和约束\n */\nexport async function up(): Promise<void> {\n  const client = await pool.connect();\n  try {\n    console.log('Running migration: Add multi-channel support...');\n\n    // 1. 创建服务表（如果不存在）\n    await client.query(`\n      CREATE TABLE IF NOT EXISTS services (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        instance_name VARCHAR(50) UNIQUE NOT NULL,\n        status VARCHAR(20) DEFAULT 'active',\n        max_channels INT DEFAULT 8,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n      )\n    `);\n    console.log('  ✅ Created services table');\n\n    // 2. 创建通道表\n    await client.query(`\n      CREATE TABLE IF NOT EXISTS channels (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        service_id UUID NOT NULL REFERENCES services(id) ON DELETE CASCADE,\n        channel_type VARCHAR(50) NOT NULL,\n        instance_number INT NOT NULL DEFAULT 1,\n        credentials JSONB NOT NULL,\n        status VARCHAR(20) DEFAULT 'active',\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        \n        -- 唯一约束：同一服务中同一通道类型的实例编号唯一\n        CONSTRAINT unique_channel_instance \n          UNIQUE(service_id, channel_type, instance_number),\n        \n        -- 检查约束：实例编号从1开始\n        CONSTRAINT instance_number_check \n          CHECK(instance_number >= 1)\n      )\n    `);\n    console.log('  ✅ Created channels table');\n\n    // 3. 创建通道容量约束（每个服务最多8个通道）\n    await client.query(`\n      CREATE OR REPLACE FUNCTION validate_channel_capacity()\n      RETURNS TRIGGER AS $$\n      BEGIN\n        IF (SELECT COUNT(*) FROM channels WHERE service_id = NEW.service_id) > 8 THEN\n          RAISE EXCEPTION 'Channel capacity exceeded: maximum 8 channels per service';\n        END IF;\n        RETURN NEW;\n      END;\n      $$ LANGUAGE plpgsql;\n\n      DROP TRIGGER IF EXISTS channel_capacity_trigger ON channels;\n      CREATE TRIGGER channel_capacity_trigger\n      BEFORE INSERT ON channels\n      FOR EACH ROW\n      EXECUTE FUNCTION validate_channel_capacity();\n    `);\n    console.log('  ✅ Created channel capacity constraint');\n\n    // 4. 创建用户-通道映射表\n    await client.query(`\n      CREATE TABLE IF NOT EXISTS user_channel_mappings (\n        id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n        user_id UUID NOT NULL,\n        channel_id UUID NOT NULL REFERENCES channels(id) ON DELETE CASCADE,\n        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n        \n        CONSTRAINT unique_user_channel \n          UNIQUE(user_id, channel_id)\n      )\n    `);\n    console.log('  ✅ Created user_channel_mappings table');\n\n    // 5. 创建索引以提高查询性能\n    await client.query(`\n      CREATE INDEX IF NOT EXISTS idx_channels_service_id ON channels(service_id);\n      CREATE INDEX IF NOT EXISTS idx_channels_type ON channels(channel_type);\n      CREATE INDEX IF NOT EXISTS idx_channels_status ON channels(status);\n      CREATE INDEX IF NOT EXISTS idx_user_channel_user_id ON user_channel_mappings(user_id);\n      CREATE INDEX IF NOT EXISTS idx_user_channel_channel_id ON user_channel_mappings(channel_id);\n    `);\n    console.log('  ✅ Created indexes');\n\n    // 6. 插入默认服务实例（如果不存在）\n    await client.query(`\n      INSERT INTO services (instance_name, status, max_channels)\n      VALUES \n        ('cloudclawd', 'active', 8),\n        ('cloudclawd2', 'active', 8)\n      ON CONFLICT (instance_name) DO NOTHING\n    `);\n    console.log('  ✅ Inserted default service instances');\n\n    console.log('\\n✅ Migration completed successfully');\n  } finally {\n    client.release();\n  }\n}\n\n/**\n * 迁移down：回滚多通道相关表和约束\n */\nexport async function down(): Promise<void> {\n  const client = await pool.connect();\n  try {\n    console.log('Reverting migration: Remove multi-channel support...');\n\n    // 删除触发器和函数\n    await client.query(`\n      DROP TRIGGER IF EXISTS channel_capacity_trigger ON channels;\n      DROP FUNCTION IF EXISTS validate_channel_capacity();\n    `);\n    console.log('  ✅ Dropped triggers and functions');\n\n    // 删除表\n    await client.query('DROP TABLE IF EXISTS user_channel_mappings');\n    console.log('  ✅ Dropped user_channel_mappings table');\n\n    await client.query('DROP TABLE IF EXISTS channels');\n    console.log('  ✅ Dropped channels table');\n\n    await client.query('DROP TABLE IF EXISTS services');\n    console.log('  ✅ Dropped services table');\n\n    console.log('\\n✅ Revert completed successfully');\n  } finally {\n    client.release();\n  }\n}\n"