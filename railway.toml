# OpenClaw Railway 部署配置

[build]
  builder = "dockerfile"
  # Dockerfile 在当前目录（openclaw-main）
  dockerfilePath = "Dockerfile"
  context = "."

  [build.args]
  FEISHU_ENABLED = "true"
  DINGTALK_ENABLED = "true"
  WECOM_ENABLED = "false"
  TELEGRAM_ENABLED = "false"
  DISCORD_ENABLED = "false"
  SLACK_ENABLED = "false"
  CACHE_BUST = "2026-02-07-PLUGIN-FIX-V11"

[deploy]
  startCommand = "bash -c 'echo \"=== 环境变量 ===\"; env | grep -E \"(GATEWAY_TRUSTED_PROXIES|RAILWAY_ENVIRONMENT|NODE_ENV|OPENCLAW_CONFIG_PATH|OPENCLAW_SKILLS|PORT)\" | sort; echo \"=== 生成配置前 ===\"; cat /data/openclaw/openclaw.json 2>/dev/null || echo \"配置文件不存在\"; /app/fix-plugin-config.sh; echo \"=== 确保controlUi配置 ===\"; node -e \"const fs=require(\\\"fs\\\"); const path=\\\"/data/openclaw/openclaw.json\\\"; const cfg=JSON.parse(fs.readFileSync(path,\\\"utf8\\\")); if (!cfg.gateway) cfg.gateway={}; if (!cfg.gateway.controlUi) cfg.gateway.controlUi={}; cfg.gateway.controlUi.enabled=true; cfg.gateway.controlUi.allowInsecureAuth=true; cfg.gateway.controlUi.dangerouslyDisableDeviceAuth=true; cfg.gateway.controlUi.basePath=\\\"/\\\"; fs.writeFileSync(path, JSON.stringify(cfg,null,2)); console.log(\\\"Ensured controlUi config\\\");\"; cat /data/openclaw/openclaw.json; echo \"=== 禁用沙箱功能 ===\"; node -e \"const fs=require(\\\"fs\\\"); const path=\\\"/data/openclaw/openclaw.json\\\"; const cfg=JSON.parse(fs.readFileSync(path,\\\"utf8\\\")); if (!cfg.agents) cfg.agents={}; if (!cfg.agents.defaults) cfg.agents.defaults={}; if (!cfg.agents.defaults.sandbox) cfg.agents.defaults.sandbox={}; cfg.agents.defaults.sandbox.mode=\\\"off\\\"; fs.writeFileSync(path, JSON.stringify(cfg,null,2)); console.log(\\\"Disabled sandbox\\\");\"; echo \"=== 启动OpenClaw ===\"; export OPENCLAW_CONFIG_PATH=/data/openclaw/openclaw.json; echo \"Using port: ${PORT:-8080}\"; exec node dist/index.js gateway --allow-unconfigured --auth token --bind lan --port ${PORT:-8080}'"
  restartPolicyType = "always"
  restartPolicyMaxRetries = 10
  # 启用重启命令，以便配置更改后可以重启服务
  [deploy.commands]
    restart = "true"

[env]
  NODE_ENV = "production"
  RAILWAY_ENVIRONMENT = "production"
  MODEL_NAME = "openrouter/stepfun/step-3.5-flash:free"
  OAUTH_ENABLED = "true"
  # 确保OpenClaw读取正确的token环境变量
  OPENCLAW_GATEWAY_TOKEN = "aE8D17b2aef960C736De1cDFDdc4806d314e2C2DebDedAe84A832fdbDefAEC7A"
  # Gateway 认证配置 - 使用token模式
  
  
  GATEWAY_AUTH_MODE = "token"
  # Gateway 配置
  GATEWAY_TRUSTED_PROXIES = "100.64.0.0/10,23.227.167.3/32,127.0.0.1/32"
  GATEWAY_BIND = "lan"
  # 端口由Railway动态分配，通过$PORT环境变量传递
  DM_SCOPE = "per-peer"
  # WebSocket 连接配置
  GATEWAY_WEBSOCKET_TIMEOUT = "3600000"
  GATEWAY_WEBSOCKET_MAX_CONNECTIONS = "200"
  GATEWAY_WEBSOCKET_HEARTBEAT = "30000"
  # 网关资源限制配置 - 针对多通道优化
  GATEWAY_RATE_LIMIT = "300/minute"
  GATEWAY_CONCURRENT_CONNECTIONS = "150"
  GATEWAY_MESSAGE_QUEUE_SIZE = "5000"
  GATEWAY_SESSION_CLEANUP_INTERVAL = "300000"
  # 会话管理优化
  GATEWAY_SESSION_IDLE_TIMEOUT = "1800000"
  GATEWAY_MAX_SESSIONS_PER_CHANNEL = "50"
  OPENCLAW_STATE_DIR = "/tmp/openclaw"
  OPENCLAW_WORKSPACE_DIR = "/tmp/workspace"
  # 修复权限问题
  HOME = "/tmp/openclaw"
  USER = "root"
  # 确保服务监听在所有接口
  BIND_ADDRESS = "0.0.0.0"
  # 确保配置文件使用正确的端口
  OPENCLAW_CONFIG_PATH = "/tmp/openclaw/openclaw.json"
  # 不设置httpService，让Railway自动检测端口

  # === 日志配置 - 解决Railway速率限制问题 ===
  # 设置日志级别为 error，只显示错误信息
  LOG_LEVEL="error"
  # 或者使用 warn 级别，显示警告和错误信息
  # LOG_LEVEL="warn"
  # 或者使用 info 级别，但减少调试信息
  # LOG_LEVEL="info"
  
  # 强制设置日志级别为 error
  OPENCLAW_LOGGING_LEVEL="error"
  
  # === 自动技能安装配置 ===
  OPENCLAW_SKILLS_AUTO_INSTALL="true"
  OPENCLAW_SKILLS_REQUIRE_CONFIRMATION="false"
  OPENCLAW_SKILLS_MAX_PER_SESSION="3"